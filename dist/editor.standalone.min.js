/*! editor 25-05-2015 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.manshar=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d=a("./selection"),e=a("./paragraph"),f=a("./utils"),g=function(a){var b=f.extend({sections:[]},a);this.selection=d.getInstance(),this.dom=document.createElement(g.TAG_NAME),this.sections=[];for(var c=0;c<b.sections.length;c++)this.insertSection(b.sections[c]);this.history=[],this.historyAt=0};b.exports=g,g.TAG_NAME="article",g.prototype.insertSection=function(a){return a.paragraphs&&a.paragraphs.length||a.insertParagraphAt(new e,0),this.sections.push(a),this.dom.appendChild(a.dom),a},g.prototype.removeSection=function(a){var b=this.sections.indexOf(a);return this.sections.splice(b,1),a},g.prototype.updateSection=function(a){return a},g.prototype.insertParagraph=function(a){var b=this.selection.getSectionAtEnd().insertParagraph(a);return b},g.prototype.removeParagraph=function(a){var b=this.sections.indexOf(a);return this.paragraphs.splice(b,1),a},g.prototype.updateParagraph=function(a){return a},g.prototype.getJSONModel=function(){for(var a={sections:[]},b=0;b<this.sections.length;b++)a.sections.push(this.sections[b].getJSONModel());return a},g.prototype.transaction=function(a){this.historyAt<this.history.length&&this.history.splice(this.historyAt,this.history.length-this.historyAt),this.history.push(a),this["do"]()},g.prototype["do"]=function(){for(var a=this.history[this.historyAt++],b=0;b<a.length;b++)this.exec(a[b],"do")},g.prototype.redo=function(){this.historyAt<this.history.length&&this["do"]()},g.prototype.undo=function(){if(this.historyAt>0)for(var a=this.history[--this.historyAt],b=a.length-1;b>=0;b--)this.exec(a[b],"undo")},g.prototype.exec=function(a,b){var c,d=a[b].op;if("updateText"===d){var f=a[b].value,g=a[b].paragraph;c=this.getParagraphByName(g),c.setText(f),this.selection.setCursor({paragraph:c,offset:a[b].cursorOffset})}else if("deleteParagraph"===d)c=this.getParagraphByName(a[b].paragraph),c.section.removeParagraph(c);else if("insertParagraph"===d){var h=this.getSectionByName(a[b].section);h.insertParagraphAt(new e({name:a[b].paragraph}),a[b].index)}},g.prototype.getSectionByName=function(a){for(var b=0;b<this.sections.length;b++)if(this.sections[b].name===a)return this.sections[b]},g.prototype.getParagraphByName=function(a){for(var b=0;b<this.sections.length;b++)for(var c=0;c<this.sections[b].paragraphs.length;c++)if(this.sections[b].paragraphs[c].name===a)return this.sections[b].paragraphs[c]}},{"./paragraph":4,"./selection":6,"./utils":7}],2:[function(a,b,c){"use strict";var d=a("./article"),e=a("./paragraph"),f=a("./section"),g=a("./utils"),h=function(a){this.element=a,this.article=null,this.init()};h.prototype=new g.CustomEventTarget,b.exports=h,h.prototype.init=function(){var a=new f({paragraphs:[new e({placeholderText:"Manshar Editor Demo",paragraphType:e.Types.MainHeader}),new e({placeholderText:"This is just a demo.",paragraphType:e.Types.ThirdHeader}),new e({placeholderText:"Play around and see the internal model of the article being displayed to the right. The Editor is still under development."})]});this.article=new d({sections:[a]}),this.article.selection.initSelectionListener(this.element),this.element.addEventListener("keydown",this.handleKeyDownEvent.bind(this)),this.element.className+=" manshar-editor",this.element.setAttribute("contenteditable",!0),this.element.appendChild(this.article.dom),this.article.selection.setCursor({paragraph:a.paragraphs[0],offset:0})},h.prototype.handleKeyDownEvent=function(a){var b=this.article.selection,c=!1,d=[],e=[];if(g.isUndo(a))this.article.undo(),c=!0;else if(g.isRedo(a))this.article.redo(),c=!0;else if(b.isRange()&&g.willTypeCharacter(a)){var f=b.getSectionAtStart();e=f.getParagraphsBetween(b.start.paragraph,b.end.paragraph);for(var h=0;h<e.length;h++){d.push({"do":{op:"updateText",paragraph:e[h].name,cursorOffset:0,value:""},undo:{op:"updateText",paragraph:e[h].name,cursorOffset:e[h].text.length,value:e[h].text}});var i=f.paragraphs.indexOf(e[h]);d.push({"do":{op:"deleteParagraph",paragraph:e[h].name},undo:{op:"insertParagraph",section:e[h].section.name,paragraph:e[h].name,index:i-h}})}if(b.end.paragraph!==b.start.paragraph){var j=b.end.paragraph.text,k=j.substring(b.end.offset,j.length),l=f.paragraphs.indexOf(b.end.paragraph);d.push({"do":{op:"updateText",paragraph:b.end.paragraph.name,cursorOffset:0,value:""},undo:{op:"updateText",paragraph:b.end.paragraph.name,cursorOffset:b.end.offset,value:j}}),d.push({"do":{op:"deleteParagraph",paragraph:b.end.paragraph.name},undo:{op:"insertParagraph",section:b.end.paragraph.section.name,paragraph:b.end.paragraph.name,index:l-e.length}});var m=b.start.paragraph.text,n=m.substring(0,b.start.offset);d.push({"do":{op:"updateText",paragraph:b.start.paragraph.name,cursorOffset:n.length,value:n+k},undo:{op:"updateText",paragraph:b.start.paragraph.name,cursorOffset:b.start.offset,value:m}})}this.article.transaction(d),d=[];var o=[13,8,46];c=-1!==o.indexOf(a.keyCode)}var p,q=b.getParagraphAtEnd(),r=q.section.paragraphs.indexOf(q),s=q.getNextParagraph(),t=q.getPreviousParagraph();switch(a.keyCode){case 13:var u=g.getUID();if(b.isCursorAtEnding())s&&s.isPlaceholder()?b.setCursor({paragraph:s,offset:0}):d.push({"do":{op:"insertParagraph",section:b.end.paragraph.section.name,paragraph:u,index:r-e.length+1},undo:{op:"deleteParagraph",paragraph:u}});else{var v=q.text.substring(b.end.offset,q.text.length),w=q.text.substring(0,b.start.offset);d.push({"do":{op:"insertParagraph",section:b.end.paragraph.section.name,paragraph:u,index:r-e.length+1},undo:{op:"deleteParagraph",paragraph:u}}),d.push({"do":{op:"updateText",paragraph:q.name,cursorOffset:w.length,value:w},undo:{op:"updateText",paragraph:q.name,cursorOffset:w.length,value:q.text}}),d.push({"do":{op:"updateText",paragraph:u,cursorOffset:0,value:v},undo:{op:"updateText",paragraph:u,cursorOffset:0,value:""}})}this.article.transaction(d),c=!0;break;case 8:b.isCursorAtBeginning()&&t&&(p=t.text.length,d.push({"do":{op:"updateText",paragraph:q.name,cursorOffset:0,value:""},undo:{op:"updateText",paragraph:q.name,cursorOffset:0,value:q.text}}),d.push({"do":{op:"deleteParagraph",paragraph:q.name},undo:{op:"insertParagraph",section:q.section.name,paragraph:q.name,index:r-e.length}}),d.push({"do":{op:"updateText",paragraph:t.name,cursorOffset:p,value:t.text+q.text},undo:{op:"updateText",paragraph:t.name,cursorOffset:p,value:t.text}}),this.article.transaction(d),b.setCursor({paragraph:t,offset:p}),c=!0);break;case 46:b.isCursorAtEnding()&&s&&(p=q.text.length,d.push({"do":{op:"updateText",paragraph:s.name,cursorOffset:0,value:""},undo:{op:"updateText",paragraph:s.name,cursorOffset:0,value:s.text}}),d.push({"do":{op:"deleteParagraph",paragraph:s.name},undo:{op:"insertParagraph",section:s.section.name,paragraph:s.name,index:r+1-e.length}}),d.push({"do":{op:"updateText",paragraph:q.name,cursorOffset:p,value:q.text+s.text},undo:{op:"updateText",paragraph:q.name,cursorOffset:p,value:q.text}}),this.article.transaction(d),b.setCursor({paragraph:q,offset:p}),c=!0)}if(c)a.preventDefault(),a.stopPropagation();else if(q&&g.willTypeCharacter(a)){var x=q.text,y=this.article,z=8===a.keyCode?-1:1;setTimeout(function(){d.push({"do":{op:"updateText",paragraph:q.name,cursorOffset:b.end.offset+z,value:q.dom.innerText},undo:{op:"updateText",paragraph:q.name,cursorOffset:b.end.offset,value:x}}),y.transaction(d)},5)}var A=this.dispatchEvent.bind(this);setTimeout(function(){A(new Event("change"))},10)},h.prototype.getJSONModel=function(){return this.article.getJSONModel()}},{"./article":1,"./paragraph":4,"./section":5,"./utils":7}],3:[function(a,b,c){"use strict";b.exports.Editor=a("./editor"),b.exports.Article=a("./article"),b.exports.Paragraph=a("./paragraph"),b.exports.Section=a("./section"),b.exports.Selection=a("./selection")},{"./article":1,"./editor":2,"./paragraph":4,"./section":5,"./selection":6}],4:[function(a,b,c){"use strict";var d=a("./utils"),e=function(a){var b=d.extend({text:"",placeholderText:null,paragraphType:e.Types.Paragraph,name:d.getUID()},a);this.name=b.name,d.setReference(this.name,this),this.text=b.text,this.placeholderText=b.placeholderText,this.markups=[],this.metadata={},this.layout={},this.section=null,this.paragraphType=b.paragraphType,this.dom=document.createElement(this.paragraphType),this.dom.setAttribute("name",this.name),this.placeholderText?this.dom.setAttribute("placeholder",this.placeholderText):this.text.length||(this.dom.innerHTML="&#8203;"),this.setText(b.text)};b.exports=e,e.Types={Paragraph:"p",MainHeader:"h1",SecondaryHeader:"h2",ThirdHeader:"h3",Media:"figure",Embed:"embed",Iframe:"iframe"},e.prototype.setText=function(a){this.text=a||"",this.text.length||this.placeholderText?this.dom.innerText=this.text:this.dom.innerHTML="&#8203;"},e.prototype.isPlaceholder=function(){return!!this.placeholderText&&!this.text.length},e.prototype.getNextParagraph=function(){if(this.section){var a=this.section.paragraphs.indexOf(this);return this.section.paragraphs[a+1]}},e.prototype.getPreviousParagraph=function(){if(this.section){var a=this.section.paragraphs.indexOf(this);return this.section.paragraphs[a-1]}},e.prototype.getJSONModel=function(){var a={name:this.name,text:this.text,paragraphType:this.paragraphType};return a}},{"./utils":7}],5:[function(a,b,c){"use strict";var d=a("./selection"),e=a("./utils"),f=function(a){var b=e.extend({paragraphs:[],background:{},name:e.getUID()},a);this.name=b.name,e.setReference(this.name,this),this.background=b.background,this.dom=document.createElement(f.TAG_NAME),this.dom.setAttribute("name",this.name),this.paragraphs=[];for(var c=0;c<b.paragraphs.length;c++)this.insertParagraphAt(b.paragraphs[c],c)};b.exports=f,f.TAG_NAME="section",f.prototype.insertParagraphAt=function(a,b){a.section=this;var c=this.paragraphs[b];return c?this.dom.insertBefore(a.dom,c.dom):this.dom.appendChild(a.dom),this.paragraphs.splice(b,0,a),d.getInstance().setCursor({paragraph:a,offset:0}),a},f.prototype.removeParagraph=function(a){var b=this.paragraphs.indexOf(a),c=this.paragraphs.splice(b,1)[0];return this.dom.removeChild(c.dom),c},f.prototype.getParagraphsBetween=function(a,b){for(var c=[],d=this.paragraphs.indexOf(a)+1,e=this.paragraphs.indexOf(b),f=d;e>f;f++)c.push(this.paragraphs[f]);return c},f.prototype.getJSONModel=function(){for(var a={paragraphs:[]},b=0;b<this.paragraphs.length;b++)a.paragraphs.push(this.paragraphs[b].getJSONModel());return a}},{"./selection":6,"./utils":7}],6:[function(a,b,c){"use strict";var d=a("./utils"),e=function(){var a=function(){this.start={paragraph:null,offset:null},this.end={paragraph:null,offset:null}};a.prototype.reset=function(){this.start={paragraph:null,offset:null},this.end={paragraph:null,offset:null}},a.prototype.getParagraphAtStart=function(){return this.start?this.start.paragraph:void 0},a.prototype.getParagraphAtEnd=function(){return this.end?this.end.paragraph:void 0},a.prototype.getSectionAtStart=function(){return this.getParagraphAtStart()?this.getParagraphAtStart().section:void 0},a.prototype.getSectionAtEnd=function(){return this.getParagraphAtEnd()?this.getParagraphAtEnd().section:void 0},a.prototype.setCursor=function(a){this.start={paragraph:a.paragraph,offset:a.offset},this.end={paragraph:a.paragraph,offset:a.offset},this.updateWindowSelectionFromModel()},a.prototype.updateWindowSelectionFromModel=function(){var a=document.createRange(),b=this.start.paragraph.dom;this.start.offset>0&&(b=b.firstChild),a.setStart(b,this.start.offset);var c=this.end.paragraph.dom;this.end.offset>0&&(c=c.firstChild),a.setEnd(c,this.end.offset);var d=window.getSelection();d.removeAllRanges(),d.addRange(a)},a.prototype.updateSelectionFromWindow=function(){var a=window.getSelection(),b=a.anchorNode,c={offset:a.anchorOffset};"#text"===b.nodeName&&(b=b.parentNode),c.paragraph=d.getReference(b.getAttribute("name"));var e=a.extentNode,f={offset:a.extentOffset};"#text"===e.nodeName&&(e=e.parentNode),f.paragraph=d.getReference(e.getAttribute("name"));var g=f.paragraph.section.paragraphs.indexOf(f.paragraph),h=c.paragraph.section.paragraphs.indexOf(c.paragraph),i=f.paragraph===c.paragraph&&f.offset<c.offset||h>g;this.end=i?c:f,this.start=i?f:c},a.prototype.isCursorAtBeginning=function(){return 0===this.start.offset&&0===this.end.offset},a.prototype.isCursorAtEnding=function(){return this.start.offset===this.start.paragraph.text.length&&this.end.offset===this.end.paragraph.text.length},a.prototype.isRange=function(){return this.start.paragraph!=this.end.paragraph||this.start.offset!=this.end.offset},a.prototype.initSelectionListener=function(a){a.addEventListener("mouseup",this.updateSelectionFromWindow.bind(this)),a.addEventListener("keyup",this.updateSelectionFromWindow.bind(this))};var b;return{getInstance:function(){return b||(b=new a,b.constructor=null),b}}}();b.exports=e},{"./utils":7}],7:[function(a,b,c){"use strict";var d={};b.exports=d,d.GLOBAL_REFERENCE={},d.extend=function(a,b){var c,d={};for(c in a)d[c]=a[c];for(c in b)d[c]=b[c];return d},d.setReference=function(a,b){d.GLOBAL_REFERENCE[a]=b},d.getReference=function(a){return d.GLOBAL_REFERENCE[a]},d.getUID=function(a){for(var b=a||4,c=[],d="abcdefghijklmnopqrstuvwxyz0123456789",e=0;b>e;e++)c.push(d.charAt(Math.floor(Math.random()*d.length)));return c.join("")},d.willTypeCharacter=function(a){var b=[16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,91,92,93,112,113,114,115,116,117,118,119,120,121,122,123,144,145];return-1===b.indexOf(a.keyCode)&&!a.ctrlKey&&!a.metaKey},d.isUndo=function(a){return!(!a.ctrlKey&&!a.metaKey||90!==a.keyCode||a.shiftKey)},d.isRedo=function(a){return!(!a.ctrlKey&&!a.metaKey||!(89===a.keyCode||a.shiftKey&&90===a.keyCode))},d.CustomEventTarget=function(){this._init()},d.CustomEventTarget.prototype._init=function(){this._registrations={}},d.CustomEventTarget.prototype._getListeners=function(a,b){var c=(b?"1":"0")+a;return c in this._registrations||(this._registrations[c]=[]),this._registrations[c]},d.CustomEventTarget.prototype.addEventListener=function(a,b,c){var d=this._getListeners(a,c),e=d.indexOf(b);-1===e&&d.push(b)},d.CustomEventTarget.prototype.removeEventListener=function(a,b,c){var d=this._getListeners(a,c),e=d.indexOf(b);-1!==e&&d.splice(e,1)},d.CustomEventTarget.prototype.dispatchEvent=function(a){for(var b=this._getListeners(a.type,!1).slice(),c=0;c<b.length;c++)b[c].call(this,a);return!a.defaultPrevented}},{}]},{},[3])(3)});